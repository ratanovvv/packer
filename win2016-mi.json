{
  "builders": [{
    "type": "azure-arm",

    "client_id": "{{ user `client_id` }}",
    "client_secret": "{{ user `client_secret` }}",
    "tenant_id": "{{ user `tenant_id` }}",
    "subscription_id": "{{ user `subscription_id` }}",
    "object_id": "{{ user `object_id` }}",

    "managed_image_resource_group_name": "{{ user `managed_image_resource_group_name` }}",
    "managed_image_name": "{{ user `managed_image_name` }}",

    "os_type": "Windows",
    "image_publisher": "MicrosoftWindowsServer",
    "image_offer": "WindowsServer",
    "image_sku": "2016-Datacenter-with-Containers",

    "communicator": "winrm",
    "winrm_use_ssl": "true",
    "winrm_insecure": "true",
    "winrm_timeout": "3m",
    "winrm_username": "{{ user `ssh_username` }}",
    "winrm_password": "{{ user `ssh_password` }}",


    "azure_tags": {
        "dept": "Engineering",
        "task": "Image deployment"
    },

    "location": "{{ user `build_region` }}",
    "vm_size": "Standard_D2_v2"
  }],

  "provisioners": [{
    "user": "{{ user `ssh_username` }}",
    "type": "ansible",
    "playbook_file": "./tc-builder.yml",
    "ansible_env_vars": [ "ANSIBLE_TIMEOUT=3000" ],
    "extra_arguments": [
        "--connection", "packer", "-vvv",
        "--extra-vars", "ansible_shell_type=powershell ansible_shell_executable=None ansible_winrm_server_cert_validation=ignore"
      ]
    },
    {
    "type": "windows-restart"
    },
    {
    "type": "powershell",
    "inline": [
      "if( Test-Path $Env:SystemRoot\\windows\\system32\\Sysprep\\unattend.xml ){ rm $Env:SystemRoot\\windows\\system32\\Sysprep\\unattend.xml -Force}",
      "& $env:SystemRoot\\System32\\Sysprep\\Sysprep.exe /oobe /generalize /quiet /quit",
      "while($true) { $imageState = Get-ItemProperty HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Setup\\State | Select ImageState; if($imageState.ImageState -ne 'IMAGE_STATE_GENERALIZE_RESEAL_TO_OOBE') { Write-Output $imageState.ImageState; Get-Content -LiteralPath C:\\windows\\system32\\sysprep\\panther\\setupact.log; Start-Sleep -s 10  } else { break } }"
    ]
  }
  ]
}